<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<link rel="shortcut icon"
	href="../../../resources/images/img/favicon.ico" type="image/x-icon" />
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>WeStudy Admin</title>
<meta name="description" content="Sufee Admin - HTML5 Admin Template">
<meta name="viewport" content="width=device-width, initial-scale=1">

<div th:replace="/user/includes/bootstrap_link :: bootstrap_link"></div>

</head>

<style>
.cover4 {
	background-image:
		url(../../../../resources/images/img/boardsupportstatus.jpg);
	background-position: center center;
	background-size: 2000px;
	background-repeat: no-repeat;
	opacity: 0.7;
}

._border_box_shadow2 {
	background: #fff;
	margin: auto;
	margin-top: 20px;
	margin-bottom: 20px;
	width: 1085px;
	box-shadow: 1px 2px 10px 1px rgba(0, 0, 0, 0.16), 0 2px 5px 0
		rgba(0, 0, 0, 0.26);
	border-radius: 3px;
	padding: 30px;
	box-shadow: 1px 2px 10px 1px rgba(0, 0, 0, 0.16), 0 2px 5px 0
		rgba(0, 0, 0, 0.26);
}

body {
	background: #F9FBFC !important;
}

/* 라디오버튼 */
._form_radio {
	background: #fff;
	/*    width: 509px; */
	margin: auto;
	padding: 30px;
	min-width: 320px;
	max-width: 540px;
	box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.16), 0 1px 5px 0
		rgba(0, 0, 0, 0.26);
	border-radius: 3px;
}

#doing_study_row {
	text-align: center;
	height: 30px;
	width: 100%;
}

#doing_study_col {
	align-self: center;
}

#button_approval {
	line-height: normal;
	background-color: #00d463;
	border-color: #00d463;
}
</style>

<body>

	<div th:replace="/user/includes/header :: header"></div>

	<sec:authorize access="isAuthenticated()">
		<sec:authentication property="principal.username" var="user_id" />
		<!-- 배너 -->
		<main id="main">
			<!-- ======= Breadcrumbs Section ======= -->
			<section class="breadcrumbs cover4"
				style="margin-top: 0px; height: 300px; padding: 1000 0 100 0px;">
				<div class="container d-flex h-100" style="padding: 200px 0;">
					<div class="row justify-content-center align-self-center">
						<h1 style="color: white; font-size: 50px;">
							<b>지원현황</b>
						</h1>
					</div>
				</div>

			</section>
			<!-- Breadcrumbs Section -->
		</main>

		<div class="_border_box_shadow2">
			<div class="row"
				style="align-items: center; margin-top: 50px; margin-bottom: 30px;">
				<div class="col-md-6"
					style="text-align: -webkit-center; padding-left: 13px;">
					<div class="_form_radio" style="padding: 0px; height: 500px;">
						<hr style="margin-bottom: 0;" />
						<!-- 모집완료 첫번째 줄 (여기는 테이블 헤드부분) -->
						<div class="row"
							style="background-color: rgb(213, 235, 217); text-align: center; height: 40px; width: 100%;">
							<div class="col" style="align-self: center;">
								<b>참가중인 스터디원</b>
							</div>

						</div>
						<!-- <div class="col" style="align-self: center;">No.</div> -->
						<div class="row"
							style="background-color: rgb(232, 241, 233); text-align: center; height: 32px; width: 100%">
							<div class="col" id="doing_study_col">
								<b>아이디</b>
							</div>
							<div class="col" id="doing_study_col">
								<b>승인여부</b>
							</div>
						</div>
						<div class="row"
							style="text-align: center; height: 25px; width: 100%"></div>

						<div id="success">
							<th:block th:each="list,index : ${status}">
								<th:block th:switch="${index.index}">
									<th:block th:case="0">
										<div class="row"
											style="text-align: center; margin-bottom: 10px; font-size: x-large; width: 100%">
											<div class="col-md-6" id="doing_study_col">

												<span th:if="${list.ROLE_NAME == '방장'}"> <span
													th:text="${list.USER_ID}"></span> <!-- 방장 아이콘 추가 -->
												</span>
											</div>
											<div class="col-md-6" id="doing_study_col">
												<img
													src="https://user-images.githubusercontent.com/61257242/87928038-2534c100-cabf-11ea-8099-c5edf44d6126.jpeg"
													alt="" style="height:32px;" />
											</div>
										</div>
									</th:block>

									<th:block th:case="*">
										<th:block
											th:if="${list.ACCEPT_STATUS} == '승인완료' and ${list.ROLE_NAME} == '회원'">
											<div class="row" th:classappend="|left${list.USER_ID}|"
												style="text-align: center; margin-bottom: 10px; width: 100%; font-size: x-large;">
												<div class="col-md-6">
													<span class="row" th:classappend="|cancel${list.USER_ID}|"
														id="doing_study_row"> <span class="col"
														id="doing_study_col">
															<p style="margin-left: 30px;" th:text="${list.USER_ID}"></p>
													</span>
													</span>
												</div>
												<!-- 현재 로그인한 사용자와 방장의 아아디가 같으면 모든회원마다 버튼이 생겨야됨  -->
					
					
											<th:block th:if="${s_board_staus} == '모집중'">
												<th:block th:if="${writer} == ${id}">
													<div class="col-md-6">
														<button type="button" class="btn btn-danger btn"
															th:onclick="|javascript:cancel('${list.USER_ID}','${list.S_SEQ}')|"
															th:classappend="|cancel${list.USER_ID}|"
															style="line-height: normal;">
															<span style="font-size: smaller;">취소</span>
														</button>
													</div>
												</th:block>
											</th:block>
												
												
												
											</div>
										</th:block>
									</th:block>
								</th:block>
							</th:block>
						</div>

						<!-- 회원정보 반복 끝 (더미데이터 끝) -->
					</div>
				</div>
				<div class="col-md-6"
					style="text-align: -webkit-center; padding-left: 0;">
					<div class="_form_radio" style="padding: 0px; height: 500px;">
						<hr style="margin-bottom: 0;" />
						<!-- 모집중 첫번째 줄 (여기는 테이블 헤드부분) -->
						<div class="row"
							style="background-color: rgb(213, 235, 217); text-align: center; height: 40px; width: 100%">
							<div class="col" id="doing_study_col">
								<b>승인 대기중</b>
							</div>
						</div>
						<div class="row"
							style="background-color: rgb(232, 241, 233); text-align: center; height: 32px; width: 100%">
							<div class="col" id="doing_study_col">
								<b>아이디</b>
							</div>
							<div class="col" id="doing_study_col">
								<b>승인여부</b>
							</div>
						</div>
						<div class="row" style="height: 25px;"></div>
						<!--    <div class="row"
                     style="text-align: center; height: 35px; width: 100%"> -->

						<div id="wait">
							<th:block th:each="list,index : ${status}">

								<th:block th:switch="${index.index}">

									<th:block th:case="0">
										<th:block th:if="${s_board_staus} == '모집완료'">
											모집이 완료 되었습니다.
										</th:block>
										<th:block th:unless="${s_board_staus} == '모집중'">

										</th:block>
									</th:block>

									<th:block th:case="*">
										<th:block
											th:if="${list.ACCEPT_STATUS} == '승인대기중' and ${list.ROLE_NAME} == '회원'">
											<div class="row" th:classappend="|right${list.USER_ID}|"
												style="text-align: center; margin-bottom: 10px; width: 100%">
												<div class="col-md-6">
													<span class="row" id="doing_study_row"> <span
														class="col" id="doing_study_col"
														style="font-size: x-large">
															<p style="margin-left: 30px;" th:text="${list.USER_ID}"></p>
													</span>
													</span>
												</div>
												<!-- 현재 로그인한 사용자와 방장의 아아디가 같으면 모든회원마다 버튼이 생겨야됨  -->

												<th:block th:if="${writer} == ${id}">
													<div class="col-md-6">
														<button type="button"
															th:onclick="|javascript:accept('${list.USER_ID}','${list.S_SEQ}')|"
															class="btn btn-success btn" id="button_approval">
															<span style="font-size: smaller;">승인</span>
														</button>
														<button type="button"
															th:onclick="|javascript:reject('${list.USER_ID}','${list.S_SEQ}')|"
															class="btn btn-danger btn" style="line-height: normal;">
															<span style="font-size: smaller;">거절</span>
														</button>
													</div>
												</th:block>
											</div>

										</th:block>
									</th:block>
								</th:block>
							</th:block>
						</div>
					</div>
				</div>
			</div>
			<th:block th:if="${writer} == ${id}">
				<th:block th:if="${s_board_staus} == '모집중'">
					<div class="row finishCheck"
						style="align-items: center; margin-top: 50px; margin-bottom: 30px; place-content: center;">
						<button type="button" th:onclick="|javascript:finishh('${s_seq}')|"
							class="btn btn-secondary btn finishh" id="finishh">
							<span style="font-size: smaller;font-weight:bold;">모집 마감</span>
						</button>
					</div>
				</th:block>
			</th:block>
		</div>

		<!-- 모집중 첫번째 줄 끝 -->

		<div th:replace="/user/includes/footer :: footer"></div>
		<div th:replace="/user/includes/bootstrap_script :: bootstrap_script"></div>
		<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>


		<script>
			//모집마감
			function finishh(s_seq) {
				//$('.finishCheck').remove();

				let data = {
					"s_seq" : s_seq
				}

				$.ajax({
					url : '/ajax/finishRecruit.do',
					processData : false,
					contentType : "application/json",
					cache : false,
					type : 'POST',
					data : JSON.stringify(data),
					success : function(data) {
						if(data != 0){
							
						$('#wait').empty();
						swal("완료되었습니다", "", "success");
						$('#wait').text('모집이 마감 되었습니다.');
						
						}else{
						
							 swal({
	                              title: "승인인원이 모집정원을 초과합니다.",
	                                icon: "warning",
	                                buttons: true
	                              })
						}


					},
					error : function(e) {
						console.log("error:", e);
					}
				});
			}
		</script>

		<script>
			function accept(user_id, s_seq) {

				let data = {
					"user_id" : user_id,
					"s_seq" : s_seq
				}

				$
						.ajax({
							url : '/ajax/accept.do',
							processData : false,
							contentType : "application/json",
							cache : false,
							type : 'POST',
							data : JSON.stringify(data),
							success : function(data) {
								//승인누른거 지우기
								$('.right' + $.escapeSelector(user_id)).remove();
								$('#success').empty();

								$
										.each(
												data,
												function(index, item) {
													var host = data[0].USER_ID;
													var id = data[data.length - 1].user_id

													let html = "";

													if (data[index].ACCEPT_STATUS === '승인완료') {

														if (data[index].ROLE_NAME === '방장') { //0번째 인덱스
															/* 		html += "<div id='success'>"; */
															html += "<div class='row' style='text-align: center; margin-bottom: 10px; font-size: x-large; width: 100%'>";
															html += "<div class='col-md-6' id='doing_study_col'>";
															html += "<span>"
																	+ data[0].USER_ID
																	+ "</span></div>";
															html += "<div class='col-md-6' id='doing_study_col'>";
															html += "<img src='https://user-images.githubusercontent.com/61257242/87928038-2534c100-cabf-11ea-8099-c5edf44d6126.jpeg' alt='' style='height:32px;' />";
															html += "</div></div>";
														} else {
															html += "<div class='row left"
																	+ data[index].USER_ID
																	+ "' id='cancel"
																	+ data[index].USER_ID
																	+ "' style='text-align: center; margin-bottom: 10px; width: 100%; font-size: x-large;'>"
															html += "<div class='col-md-6'>"

															/* html += "<span class='col' id='doing_study_col'>" */
															html += "<span style='margin-left: 30px;'>"
																	+ data[index].USER_ID
																	+ "</span></div>";
														}
														if (host === id
																&& index !== 0) {
															html += "<div class='col-md-6'>"
															html += '<button type="button" onclick=cancel("'
																	+ data[index].USER_ID
																	+ '","'
																	+ data[index].S_SEQ
																	+ '") id="cancel'
																	+ data[index].USER_ID
																	+ '" class="btn btn-danger btn" style="line-height: normal;">'
															html += "<span style='font-size: smaller;'>취소</span>"
															html += "</button></div></div></div>"
														}
													}
													$('#success').append(html);
												});
							},
							error : function(e) {
								console.log("error:", e);
							}
						});

			}

			function reject(user_id, s_seq) {

				let data = {
					"user_id" : user_id,
					"s_seq" : s_seq
				}

				$.ajax({
					url : '/ajax/reject.do',
					processData : false,
					contentType : "application/json",
					cache : false,
					type : 'POST',
					data : JSON.stringify(data),
					success : function(data) {
						//승인누른거 지우기
						$('.right' + user_id).remove();

					},
					error : function(e) {
						console.log("error:", e);
					}
				});

			}

			//승인취소
			function cancel(user_id, s_seq) {


				let data = {
					"user_id" : user_id,
					"s_seq" : s_seq
				}

				$
						.ajax({
							url : '/ajax/cancel.do',
							processData : false,
							contentType : "application/json",
							cache : false,
							type : 'POST',
							data : JSON.stringify(data),
							success : function(data) {

								//승인누른거 지우기
								$('.left' + $.escapeSelector(user_id)).remove();
								$('#wait').empty();

								$
										.each(
												data,
												function(index, item) {
													var host = data[0].USER_ID;

													var id = data[data.length - 1].user_id

													let html = "";
													/* 			if(data[index].ROLE_NAME === '방장'){ 
																	html+= "<div></div>";*/
													if (data[index].ACCEPT_STATUS === '승인대기중'
															&& data[index].ROLE_NAME === '회원') {

														/* 		html += "<div id='wait'>"; */
														html += "<div class='row right"
																+ data[index].USER_ID
																+ "' style='text-align: center; margin-bottom: 10px; width: 100%'>";
														html += "<div class='col-md-6'>";
														html += "<span class='row' id='doing_study_row'>";
														html += "<span class='col' id='doing_study_col' style='font-size: x-large'>";
														html += "<p style='margin-left: 30px;'>"
																+ data[index].USER_ID
																+ "</p></span></span>";
														html += "</div>"

														html += "<div class='col-md-6'>";

														html += '<button type="button" style="margin-right:4px;" onclick=accept("'
																+ data[index].USER_ID
																+ '","'
																+ data[index].S_SEQ
																+ '") "id="approval" class="btn btn-success btn" id="button_approval">';
														html += "<span style='font-size: smaller;'>승인</span></button>";
														html += '<button type="button" onclick=reject("'
																+ data[index].USER_ID
																+ '","'
																+ data[index].S_SEQ
																+ '") "id="reject" class="btn btn-danger btn" style="line-height: normal;">';
														html += "<span style='font-size: smaller;'>거절</span></button></div>";
														html += "</div>";

													}
													if (host === id) {
														/* html += "<div class='col-md-6'>";

														html += '<button type="button" onclick=accept("'
																+ data[index].USER_ID
																+ '", "'
																+ data[index].S_SEQ
																+ '") "id="approval" class="btn btn-success btn" id="button_approval">';
														html += "<span style='font-size: smaller;'>승인</span></button>";
														html += '<button type="button" onclick=reject("'
																+ data[index].user_ID
																+ '", "'
																+ data[index].S_SEQ
																+ '") "id="reject" class="btn btn-danger btn" style="line-height: normal;">';
														html += "<span style='font-size: smaller;'>거절</span></button></div>";
														html += "</div></div>"; */
													}

													$('#wait').append(html);
												});

							},
							error : function(e) {
								console.log("error:", e);
							}
						});

			}
			/* 
						 $(document).on("click","#cancel",function(USER_ID, S_SEQ){
						 
							cancel(user_id, s_seq);
						});
						
						$(document).on("click", "#approval",function(user_id, s_seq){
							accept(user_id, s_seq);
						});
						
						$(document).on("click", "#reject",function(user_id, s_seq){
							reject(user_id, s_seq);
						});  */
		</script>

</body>

</html>